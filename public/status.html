<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Live Queue Status</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{--bg:#0a0b0f;--card:#12131a;--muted:#9aa1ac;--accent:#4f8cff}
    body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:760px;margin:0 auto;padding:16px}
    .pill{display:inline-flex;gap:8px;align-items:center;background:#1a1c25;border:1px solid #222633;color:#fff;padding:8px 12px;border-radius:999px}
    .banner{width:100%;height:160px;background:#151823;border:1px solid #232536;border-radius:16px;overflow:hidden;margin:12px 0}
    .banner img{width:100%;height:100%;object-fit:cover}
    .card{background:var(--card);border:1px solid #262a36;border-radius:16px;padding:14px;margin:10px 0}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .progress{height:10px;border-radius:999px;background:#1c2030;overflow:hidden}
    .progress > div{height:100%;width:0%;background:var(--accent);transition:width .5s}
    .muted{color:var(--muted);font-size:13px}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid #2a2f3f;background:#141826;color:#fff;padding:10px 12px;border-radius:12px;text-decoration:none}
    .stars span{font-size:26px;cursor:pointer}
    .stars .on{filter:drop-shadow(0 0 6px #ffad0d)}
    .state{padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid #2e3448;background:#141826}
  </style>
</head>
<body>
<div class="wrap">
  <div class="row">
    <div id="orgName" class="pill">Loading...</div>
    <a class="btn" id="mapBtn" target="_blank" rel="noopener">Open Map</a>
    <a class="btn" id="gbtn" style="display:none" target="_blank" rel="noopener">Rate on Google</a>
  </div>

  <div class="banner" id="banner"><!-- filled by JS --></div>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div>
        <div class="muted">Now Serving</div>
        <div id="nowServing" style="font-size:34px;font-weight:700">—</div>
      </div>
      <div style="text-align:right">
        <div class="muted">Your Token</div>
        <div id="yourToken" style="font-size:34px;font-weight:700">—</div>
      </div>
    </div>
    <div class="progress" style="margin-top:12px"><div id="bar"></div></div>
    <div class="row" style="justify-content:space-between;margin-top:8px">
      <div class="muted">ETA: <span id="eta">—</span></div>
      <div class="state" id="state">LIVE</div>
    </div>
  </div>

  <div class="card">
    <div class="muted">Booking</div>
    <div id="binfo">—</div>
  </div>

  <div class="card">
    <div class="muted">Rate your experience</div>
    <div class="stars" id="stars">
      <span data-v="1">★</span><span data-v="2">★</span><span data-v="3">★</span><span data-v="4">★</span><span data-v="5">★</span>
    </div>
    <textarea id="revText" placeholder="Write a short review (optional)" style="width:100%;height:80px;margin-top:8px;background:#0f121b;color:#fff;border:1px solid #2a2f3f;border-radius:10px;padding:8px"></textarea>
    <button class="btn" id="sendRev" style="margin-top:8px">Submit Review</button>
  </div>
</div>

<script>
const qs = new URLSearchParams(location.search);
const org_id = qs.get('org_id');
const booking_id = qs.get('booking_id');
const token = qs.get('token');
const phone = qs.get('phone');

const el = id => document.getElementById(id);

let last = null;
let myRating = 0;

[...el('stars').querySelectorAll('span')].forEach(s=>{
  s.onclick = ()=>{ myRating = Number(s.dataset.v); paintStars(); };
});
function paintStars(){
  [...el('stars').querySelectorAll('span')].forEach(s=>{
    s.classList.toggle('on', Number(s.dataset.v) <= myRating);
  });
}

el('sendRev').onclick = async ()=>{
  if(!myRating) return alert('Please select rating');
  const body = {
    org_id,
    rating: myRating,
    review: el('revText').value || null,
    booking_id: last?.booking?.id || null,
    assigned_user_id: last?.booking?.assigned_user_id || null
  };
  const r = await fetch('/reviews', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  const j = await r.json();
  if(!j.ok) return alert(j.error || 'Failed');
  alert('Thank you for the review!');
  myRating = 0; el('revText').value = ''; paintStars();
};

async function load() {
  const url = new URL('/status/view', location.origin);
  if (org_id) url.searchParams.set('org_id', org_id);
  if (booking_id) url.searchParams.set('booking_id', booking_id);
  if (token) url.searchParams.set('token', token);
  if (phone) url.searchParams.set('phone', phone);

  const r = await fetch(url);
  const j = await r.json();
  if(!j.ok) { console.error(j); return; }
  last = j;

  const { org, booking, metrics } = j;

  el('orgName').textContent = org.name || 'Org';
  el('mapBtn').href = org.map_url || '#';
  const banner = org.banner;
  el('banner').innerHTML = banner ? `<img src="${banner}">` : '<div style="height:100%;display:flex;align-items:center;justify-content:center;color:#9aa1ac">No banner</div>';

  if (org.google_review_url) {
    el('gbtn').href = org.google_review_url; el('gbtn').style.display = 'inline-flex';
  }

  el('nowServing').textContent = metrics?.now_serving_token ?? '—';
  el('yourToken').textContent = booking?.token_number ?? (token || '—');
  el('state').textContent = (metrics?.state || 'live').toUpperCase();

  const etaSec = metrics?.eta_seconds;
  if (etaSec != null) {
    const m = Math.floor(etaSec/60), s = Math.floor(etaSec%60);
    el('eta').textContent = `${m}m ${s}s`;
  } else el('eta').textContent = '—';

  const now = Number(metrics?.now_serving_token || 0);
  const mine = Number(booking?.token_number || token || 0);
  let pct = 0;
  if (mine && now) {
    const ahead = Math.max(0, mine - now);
    const span = Math.max(1, ahead + 1);
    pct = Math.max(0, Math.min(100, ((span - ahead) / span) * 100));
  }
  el('bar').style.width = pct + '%';

  el('binfo').innerHTML = booking ? `
    <div><b>${booking.customer_name || ''}</b> (${booking.customer_phone || ''})</div>
    <div class="muted">Token #${booking.token_number} • ${booking.status || 'pending'}</div>
  ` : `<div class="muted">Open queue view</div>`;
}

load();
// Optional: Basic refresh
setInterval(load, 15000);
</script>
</body>
</html>
