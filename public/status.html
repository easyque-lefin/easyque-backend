<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1"
  />
  <title>EasyQue — Live Queue Status</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f7fbff;
      --card:#ffffff;
      --ink:#0e2233;
      --ink-dim:#4a5b6b;
      --accent:#2ea7ff;
      --accent-2:#0ad07f;
      --danger:#ff4d6d;
      --muted:#e6eef5;
      --brand:#3ba56c;
      --pill-start:#3d8bff;
      --pill-end:#ff3b7a;
      --shadow: 0 10px 24px rgba(8, 28, 44, .08);
      --round: 18px;
    }
    * { box-sizing: border-box; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif;
    }

    .page{
      max-width: 420px;
      margin: 0 auto;
      padding-bottom: 48px;
    }

    /* Header */
    .topbar{
      display:flex;
      align-items:center;
      gap:12px;
      padding:14px 16px;
    }
    .logo-wrap{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo{
      width:48px; height:48px;
      border-radius:12px;
      display:grid; place-items:center;
      background:#fff;
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .logo svg{ width:36px; height:36px; }
    .live-tag{
      font-weight:800;
      color:var(--brand);
      letter-spacing:.06em;
      font-size:12px;
    }

    /* Org pill */
    .org-pill{
      margin:8px 16px 0;
      background: linear-gradient(90deg, var(--pill-start), var(--pill-end));
      color:#fff;
      border-radius: 14px;
      padding:12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      box-shadow: var(--shadow);
    }
    .org-name{
      font-weight:800;
      font-size:18px;
      line-height:1.2;
    }
    .map-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:36px; height:36px;
      border-radius: 10px;
      background: rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.35);
      color:#fff;
      text-decoration:none;
    }
    .map-btn svg{ width:20px; height:20px; }

    /* Banner */
    .banner-card{
      margin:14px 16px;
      background:var(--card);
      border-radius: var(--round);
      box-shadow: var(--shadow);
      padding:12px;
    }
    .banner{
      width:100%;
      height:160px;
      object-fit:cover;
      border-radius: 12px;
      background:#eef4f8;
    }

    /* Queue block */
    .queue-card{
      margin:14px 16px;
      background: linear-gradient(180deg, #dff1ff 0%, #eff8ff 100%);
      border-radius: var(--round);
      padding:18px 14px 16px;
      box-shadow: var(--shadow);
      position:relative;
    }

    .break-badge{
      position:absolute;
      top:-12px;
      left:50%;
      transform: translateX(-50%);
      background:#5179ff;
      color:#fff;
      padding:8px 12px;
      font-size:11px;
      border-radius: 12px 12px 12px 12px;
      min-width: 210px;
      text-align:center;
      box-shadow: 0 8px 18px rgba(81,121,255,.35);
      display:none;
    }
    .break-badge.on{ display:block; }

    .qtop{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      margin-top:20px;
    }

    .q-col{
      width:46%;
      background:#2f66a8;
      color:#fff;
      padding:16px 10px 14px;
      border-radius: 12px;
      text-align:center;
      position:relative;
    }
    .q-title{
      font-size:13px;
      letter-spacing:.02em;
      opacity:.95;
      font-weight:600;
    }
    .q-num{
      font-weight:800;
      font-size:44px;
      line-height:1;
      margin-top:6px;
    }

    .q-people{
      width:64px;
      height:64px;
      margin:0 auto -12px;
      background: #0e2233;
      border-radius:50%;
      display:grid;
      place-items:center;
      color:#fff;
      box-shadow: 0 10px 20px rgba(14, 34, 51, .35);
    }
    .q-people svg{ width:36px; height:36px; }

    .progress{
      margin:14px auto 4px;
      width:76%;
      height:10px;
      border-radius:999px;
      background:#dbe8f2;
      overflow:hidden;
      box-shadow: inset 0 1px 2px rgba(0,0,0,.06);
    }
    .progress > i{
      display:block;
      height:100%;
      width:0%;
      background: linear-gradient(90deg, #28dba3, #8ae28a);
      transition: width .4s ease;
    }
    .progress-text{
      text-align:center;
      font-size:11px;
      color:var(--ink-dim);
      margin-top:2px;
    }

    /* Service info split pill */
    .service-pill{
      margin:14px 16px;
      background:#ffeeda;
      border-radius: 18px;
      display:flex;
      overflow:hidden;
      border:1px solid #ffd7ad;
    }
    .service-side{
      width:50%;
      padding:14px 12px;
      text-align:center;
    }
    .service-side + .service-side{
      border-left:1px dashed #ffbf83;
      background:#fff5ea;
    }
    .service-title{
      color:#ff6f32;
      font-size:13px;
      font-weight:700;
    }
    .service-value{
      margin-top:6px;
      font-weight:800;
      font-size:16px;
      color:#0e2233;
    }

    /* Booking info */
    .section-title{
      margin:18px 16px 6px;
      font-weight:800;
      text-align:center;
    }

    .book-card{
      margin:6px 16px 10px;
      background:var(--card);
      border-radius: var(--round);
      padding:14px;
      box-shadow: var(--shadow);
    }
    .row{
      display:flex;
      align-items:flex-start;
      gap:10px;
      margin:6px 0;
      font-size:14px;
      color:var(--ink);
    }
    .row b{
      width:46%;
      color:var(--ink-dim);
      font-weight:700;
    }
    .row span{
      width:54%;
      font-weight:600;
      color:#0e2233;
      word-break: break-word;
    }

    .note{
      margin:14px 16px 0;
      color:#5f6f7d;
      font-size:11.5px;
      text-align:center;
    }
  </style>
</head>
<body>
  <main class="page" id="page">

    <!-- Header -->
    <div class="topbar">
      <div class="logo-wrap">
        <div class="logo" aria-hidden="true">
          <!-- Simple mark that resembles your EasyQue tick/arrow -->
          <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <rect x="4" y="4" width="56" height="56" rx="12" fill="#eff7ef"/>
            <path d="M13 34l10 10 28-28" stroke="#24c069" stroke-width="7" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="18" cy="20" r="5" fill="#ff8b2c"/>
          </svg>
        </div>
        <div>
          <div style="font-weight:800;">EASYQUE</div>
          <div class="live-tag">LIVE  QUE  STATUS</div>
        </div>
      </div>
    </div>

    <!-- Org pill -->
    <div class="org-pill">
      <div class="org-name" id="orgName">Organization Name</div>
      <a id="mapLink" class="map-btn" href="#" target="_blank" title="Open location">
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M12 2C8.7 2 6 4.7 6 8c0 4.5 6 12 6 12s6-7.5 6-12c0-3.3-2.7-6-6-6zm0 8.2c-1.2 0-2.2-1-2.2-2.2S10.8 5.8 12 5.8s2.2 1 2.2 2.2S13.2 10.2 12 10.2z"/>
        </svg>
      </a>
    </div>

    <!-- Banner -->
    <div class="banner-card">
      <img id="bannerImg" class="banner" alt="Organization banner" src="" />
    </div>

    <!-- Queue section -->
    <section class="queue-card">
      <div id="breakBadge" class="break-badge">On break</div>

      <div class="qtop">
        <div class="q-col">
          <div class="q-title">Current Served<br/>Token</div>
          <div class="q-num" id="nowServing">–</div>
        </div>

        <div class="q-people" aria-hidden="true">
          <svg viewBox="0 0 24 24">
            <path fill="white" d="M12 12c2.2 0 4-1.8 4-4S14.2 4 12 4 8 5.8 8 8s1.8 4 4 4zm6 1h-1.3c-.8.4-1.7.7-2.7.7s-1.9-.3-2.7-.7H10c-3.3 0-6 2.7-6 6v1c0 .6.4 1 1 1h18c.6 0 1-.4 1-1v-1c0-3.3-2.7-6-6-6z"/>
          </svg>
        </div>

        <div class="q-col">
          <div class="q-title">Your<br/>Token No</div>
          <div class="q-num" id="yourToken">–</div>
        </div>
      </div>

      <div class="progress" aria-label="Queue progress">
        <i id="progressFill" style="width:0%"></i>
      </div>
      <div class="progress-text" id="progressText">0% completed</div>
    </section>

    <!-- Service info pill -->
    <div class="service-pill">
      <div class="service-side">
        <div class="service-title">Service start time</div>
        <div class="service-value" id="serviceStart">–</div>
      </div>
      <div class="service-side">
        <div class="service-title">Avg.Service time till now</div>
        <div class="service-value" id="avgService">–</div>
      </div>
    </div>

    <!-- Booking info -->
    <div class="section-title">Booking Info</div>
    <div class="book-card" id="bookCard">
      <div class="row"><b>Name:</b> <span id="userName">–</span></div>
      <div class="row"><b>Assigned User:</b> <span id="assignedUser">–</span></div>
      <div class="row"><b>Department:</b> <span id="department">–</span></div>

      <div class="row"><b>Booking ID:</b> <span id="bookingId">–</span></div>
      <div class="row"><b>Booking Date&Time:</b> <span id="bookingDT">–</span></div>
      <div class="row"><b>Phone No:</b> <span id="userPhone">–</span></div>
    </div>

    <div class="note">
      The queue status is only updated when the person you've booked marks the token as served.
      If your status isn't updating, please contact that person directly.
    </div>
  </main>

  <script>
    // -------------------------
    // Utilities
    // -------------------------
    const $ = (sel) => document.querySelector(sel);
    const params = new URLSearchParams(location.search);
    const orgId = params.get('org_id');
    const tokenNo = parseInt(params.get('token') || params.get('viewer_token') || '0', 10) || 0;
    const assignedUserId = params.get('assigned_user_id');

    const el = {
      orgName: $('#orgName'),
      mapLink: $('#mapLink'),
      banner:  $('#bannerImg'),
      nowServing: $('#nowServing'),
      yourToken: $('#yourToken'),
      progressFill: $('#progressFill'),
      progressText: $('#progressText'),
      breakBadge: $('#breakBadge'),
      serviceStart: $('#serviceStart'),
      avgService: $('#avgService'),
      userName: $('#userName'),
      assignedUser: $('#assignedUser'),
      department: $('#department'),
      bookingId: $('#bookingId'),
      bookingDT: $('#bookingDT'),
      userPhone: $('#userPhone'),
    };

    function fmtTime(dtStr){
      if(!dtStr) return '–';
      const d = new Date(dtStr);
      if(isNaN(+d)) return dtStr;
      const opts = { hour: 'numeric', minute:'2-digit' };
      return d.toLocaleTimeString([], opts);
    }
    function fmtDateTime(dtStr){
      if(!dtStr) return '–';
      const d = new Date(dtStr);
      if(isNaN(+d)) return dtStr;
      const opts = { year:'numeric', month:'2-digit', day:'2-digit',
                     hour:'2-digit', minute:'2-digit' };
      return d.toLocaleString([], opts);
    }
    function fmtMinutes(sec){
      if(!Number.isFinite(sec)) return '–';
      const m = Math.round(sec/60);
      return m <= 1 ? '1 minute' : `${m} minutes`;
    }

    // Normalize server payloads to one shape this UI understands.
    function normalizeServerShape(raw){
      // Expected from /status/view:
      // {
      //   org: { id, name, map_url, banner_url },
      //   booking: {
      //     id, token_no, user_name, user_phone, department,
      //     assigned_user_id, assigned_user_name, booking_datetime
      //   },
      //   metrics: {
      //     now_serving_token, avg_service_seconds, service_start_at,
      //     on_break, break_until
      //   }
      // }
      const n = {
        org: {
          id: raw?.org?.id ?? orgId,
          name: raw?.org?.name ?? 'Organization',
          map_url: raw?.org?.map_url ?? '#',
          banner_url: raw?.org?.banner_url ?? `/orgs/${orgId}/banner`
        },
        booking: {
          id: raw?.booking?.id ?? null,
          token_no: raw?.booking?.token_no ?? tokenNo,
          user_name: raw?.booking?.user_name ?? '',
          user_phone: raw?.booking?.user_phone ?? '',
          department: raw?.booking?.department ?? '',
          assigned_user_id: raw?.booking?.assigned_user_id ?? assignedUserId,
          assigned_user_name: raw?.booking?.assigned_user_name ?? '',
          booking_datetime: raw?.booking?.booking_datetime ?? ''
        },
        metrics: {
          now_serving_token: raw?.metrics?.now_serving_token ?? null,
          avg_service_seconds: raw?.metrics?.avg_service_seconds ?? null,
          service_start_at: raw?.metrics?.service_start_at ?? null,
          on_break: !!raw?.metrics?.on_break,
          break_until: raw?.metrics?.break_until ?? null
        }
      };
      return n;
    }

    function setProgress(nowServing, yourToken){
      if(!yourToken || yourToken <= 0){
        el.progressFill.style.width = '0%';
        el.progressText.textContent = '0% completed';
        return;
      }
      // crude progress: nowServing / yourToken
      const ratio = Math.max(0, Math.min(1, (nowServing || 0) / yourToken));
      const pct = Math.round(ratio*100);
      el.progressFill.style.width = pct + '%';
      el.progressText.textContent = pct + '% completed';
    }

    function renderInitial(state){
      const { org, booking, metrics } = state;

      el.orgName.textContent = org.name || 'Organization';
      el.mapLink.href = org.map_url || '#';

      // Banner: if your backend serves /orgs/:id/banner, we use that by default.
      el.banner.src = org.banner_url || `/orgs/${orgId}/banner`;

      el.yourToken.textContent = booking.token_no ?? '–';
      el.userName.textContent = booking.user_name || '–';
      el.userPhone.textContent = booking.user_phone || '–';
      el.department.textContent = booking.department || '–';
      el.assignedUser.textContent = booking.assigned_user_name || '–';
      el.bookingId.textContent = booking.id ?? '–';
      el.bookingDT.textContent = fmtDateTime(booking.booking_datetime);

      el.nowServing.textContent = metrics.now_serving_token ?? '–';
      el.serviceStart.textContent = fmtTime(metrics.service_start_at);
      el.avgService.textContent = fmtMinutes(metrics.avg_service_seconds);

      // Break badge
      if(metrics.on_break){
        const until = metrics.break_until ? fmtTime(metrics.break_until) : '';
        el.breakBadge.textContent = until ? `On break till ${until}` : 'On break';
        el.breakBadge.classList.add('on');
      } else {
        el.breakBadge.classList.remove('on');
      }

      setProgress(metrics.now_serving_token, booking.token_no);
    }

    function applyLivePatch(patch){
      // Patch may contain any of: now_serving_token, avg_service_seconds,
      // service_start_at, on_break, break_until
      if(patch.now_serving_token !== undefined){
        el.nowServing.textContent = patch.now_serving_token ?? '–';
        const yourToken = parseInt(el.yourToken.textContent || '0', 10);
        setProgress(patch.now_serving_token, yourToken);
      }
      if(patch.avg_service_seconds !== undefined){
        el.avgService.textContent = fmtMinutes(patch.avg_service_seconds);
      }
      if(patch.service_start_at !== undefined){
        el.serviceStart.textContent = fmtTime(patch.service_start_at);
      }
      if(patch.on_break !== undefined){
        if(patch.on_break){
          const until = patch.break_until ? fmtTime(patch.break_until) : '';
          el.breakBadge.textContent = until ? `On break till ${until}` : 'On break';
          el.breakBadge.classList.add('on');
        } else {
          el.breakBadge.classList.remove('on');
        }
      }
      if(patch.break_until !== undefined && el.breakBadge.classList.contains('on')){
        const until = patch.break_until ? fmtTime(patch.break_until) : '';
        el.breakBadge.textContent = until ? `On break till ${until}` : 'On break';
      }
    }

    async function loadInitial(){
      const qs = new URLSearchParams({
        org_id: orgId,
        token: tokenNo,
        assigned_user_id: assignedUserId
      }).toString();

      // If your existing backend uses a different path, update here:
      const res = await fetch(`/status/view?${qs}`, { credentials:'same-origin' });
      if(!res.ok){
        // Fallback: try to at least show banner + org
        renderInitial(normalizeServerShape({}));
        return;
      }
      const raw = await res.json();
      const state = normalizeServerShape(raw);
      renderInitial(state);
    }

    function startSSE(){
      const sseQs = new URLSearchParams({
        org_id: orgId,
        token: tokenNo,
        assigned_user_id: assignedUserId
      }).toString();

      const es = new EventSource(`/live/stream?${sseQs}`);
      es.addEventListener('message', (ev) => {
        try{
          const patch = JSON.parse(ev.data);
          applyLivePatch(patch);
        }catch(_){}
      });
      es.addEventListener('error', () => {
        // backoff is handled by browser; page keeps showing last values
      });
    }

    (async function boot(){
      // Guard for missing params
      if(!orgId || !tokenNo){
        // Still render the shell and show placeholders
        renderInitial(normalizeServerShape({}));
        return;
      }
      await loadInitial();
      startSSE();
    })();
  </script>
</body>
</html>

