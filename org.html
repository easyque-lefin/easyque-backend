
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>EasyQue - Organization setup</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; max-width:1000px; }
    .card { background:#fff;border:1px solid #ddd;padding:18px;border-radius:8px;margin-bottom:20px; }
    label { display:block;margin-top:8px;font-weight:600; }
    input, textarea, select { width:100%; padding:8px; margin-top:6px; box-sizing:border-box; border:1px solid #ccc;border-radius:6px; }
    button { padding:8px 12px;border-radius:6px;border:0;background:#007bff;color:#fff;margin-top:12px; cursor:pointer; }
    .muted { color:#666; font-size:0.9em; }
    #orgMsg, #inviteMsg { margin-top:8px; }
  </style>
</head>
<body>

<!-- Fee settings editor (admin only) -->
<div style="margin-top:20px;border:1px solid #eee;padding:12px;border-radius:8px;max-width:760px;">
  <h3>Fee settings</h3>
  <div id="feeList" style="margin-bottom:8px;"></div>
  <div style="display:flex;gap:8px;align-items:center;">
    <input id="fee_key" placeholder="fee key (e.g. monthly_platform_fee_per_user)" style="flex:1;padding:8px;">
    <input id="fee_value" placeholder="value (number or text)" style="width:160px;padding:8px;">
    <button id="btnSaveFee" style="padding:8px 12px;">Save</button>
  </div>

  <h4 style="margin-top:12px;">View charges (sample)</h4>
  <label>Mode:
    <select id="preview_mode">
      <option value="semi">Semi (no provider)</option>
      <option value="full">Full (we send messages)</option>
    </select>
  </label>
  <label>Users: <input id="preview_users" type="number" value="10"></label>
  <label>Bookings/day (full mode only): <input id="preview_bookings" type="number" value="500"></label>
  <div style="margin-top:8px;">
    <button id="btnPreview" style="padding:8px 12px;">Calculate charge</button>
    <div id="preview_result" style="margin-top:8px;font-weight:bold;"></div>
  </div>
</div>

<script>
(async function(){
  const base = window.location.origin;
  const token = localStorage.getItem('accessToken');

  async function loadFees() {
    try {
      const r = await fetch(base + '/admin/fees', { headers: { Authorization: 'Bearer ' + token }});
      const j = await r.json();
      const list = document.getElementById('feeList');
      list.innerHTML = '';
      if (j.ok && j.fees) {
        for (const k of Object.keys(j.fees)) {
          const v = j.fees[k].value_decimal !== null ? j.fees[k].value_decimal : j.fees[k].value_text;
          const row = document.createElement('div');
          row.textContent = k + ' = ' + v;
          list.appendChild(row);
        }
      } else {
        list.textContent = 'No fees loaded or permission denied';
      }
    } catch (e) {
      console.error('loadFees', e);
    }
  }

  document.getElementById('btnSaveFee').addEventListener('click', async () => {
    const key = document.getElementById('fee_key').value.trim();
    const value = document.getElementById('fee_value').value.trim();
    if (!key) { alert('Enter key'); return; }
    try {
      const r = await fetch(base + '/admin/fees', {
        method: 'PUT',
        headers: { 'Content-Type':'application/json', Authorization: 'Bearer ' + token },
        body: JSON.stringify({ key, value })
      });
      const j = await r.json();
      if (!r.ok || !j.ok) alert('Save failed: ' + (j && j.error));
      else {
        alert('Saved');
        loadFees();
      }
    } catch (e) {
      alert('Save error: ' + e.message);
    }
  });

  document.getElementById('btnPreview').addEventListener('click', async () => {
    try {
      const mode = document.getElementById('preview_mode').value;
      const users = Number(document.getElementById('preview_users').value || 0);
      const bookings = Number(document.getElementById('preview_bookings').value || 0);
      const r = await fetch(base + '/admin/fees', { headers: { Authorization: 'Bearer ' + token }});
      const j = await r.json();
      if (!r.ok || !j.ok) { alert('Cannot load fees'); return; }
      const fees = {};
      for (const k of Object.keys(j.fees)) {
        fees[k] = j.fees[k].value_decimal !== null ? Number(j.fees[k].value_decimal) : null;
      }
      let amount = 0;
      if (mode === 'semi') {
        amount = (fees['annual_fee'] || 0) + users * (fees['monthly_platform_fee_per_user'] || 0);
      } else {
        const monthly_platform_total = users * (fees['monthly_platform_fee_per_user'] || 0);
        const estimated_message_cost_30 = bookings * (fees['message_cost_per_booking'] || 0) * 30;
        amount = monthly_platform_total + estimated_message_cost_30;
      }
      document.getElementById('preview_result').textContent = 'Estimated initial amount: ₹' + amount;
    } catch (e) { console.error('preview error', e); alert('Error calculating preview'); }
  });

  loadFees();
})();
</script>

  <h1>Organization setup</h1>
  <div class="card">
    <div id="loggedIn" class="muted">Logged in as ...</div>
    <h3>Organization Details</h3>
    <label>Name</label><input id="orgName">
    <label>Location</label><input id="orgLocation">
    <label>Services</label><textarea id="orgServices"></textarea>
    <label>Photo URL (public)</label><input id="orgPhoto" placeholder="https://...">
    <button id="btnSaveOrg">Save Organization</button>
    <div id="orgMsg"></div>
  </div>

  <div class="card">
    <h3>Or — Search existing organization (admin)</h3>
    <label>Search by id or name</label><input id="searchOrgQ"><button id="btnSearchOrg">Search</button>
    <div id="searchResults"></div>
  </div>

  <div class="card">
    <h3>Add Assigned / Receptionist</h3>
    <div class="muted">Selected organization: <span id="selectedOrg">None</span></div>
    <label>Role</label>
    <select id="userRole"><option value="assigned">Assigned user</option><option value="receptionist">Receptionist</option></select>
    <label>Name</label><input id="userName">
    <label>Email</label><input id="userEmail">
    <label>Department</label><input id="userDept">
    <button id="btnInvite">Send Invite</button>
    <div id="inviteMsg"></div>
  </div>

  <div style="margin-top:10px">
    <button id="btnSkip">Skip and Continue to Bookings</button>
  </div>

<script>
const base=window.location.origin;
let me=null,selectedOrgId=null;

function getToken(){return localStorage.getItem('accessToken')||'';}
function headers(){return {'Content-Type':'application/json','Authorization':'Bearer '+getToken()};}

async function whoami(){
  const t=getToken(); if(!t) return window.location='/index.html';
  try{
    const r=await fetch(base+'/auth/me',{headers:{Authorization:'Bearer '+t}});
    if(!r.ok) return window.location='/index.html';
    const j=await r.json(); if(!j.ok) return window.location='/index.html';
    me=j.user; document.getElementById('loggedIn').innerText=`Logged in as ${me.name} (${me.role})`;
    if(me.org_id){selectedOrgId=me.org_id;document.getElementById('selectedOrg').innerText='Org ID: '+me.org_id;}
  }catch(e){window.location='/index.html';}
}
whoami();

document.getElementById('btnSaveOrg').onclick=async()=>{
  const name=orgName.value.trim(),location=orgLocation.value.trim(),services=orgServices.value.trim(),photo=orgPhoto.value.trim();
  const msg=orgMsg; msg.textContent='Saving...';
  try{
    const r=await fetch(base+'/organizations',{method:'POST',headers:headers(),body:JSON.stringify({name,location,services,photo})});
    const j=await r.json(); if(!r.ok){msg.style.color='red';msg.textContent=JSON.stringify(j);return;}
    selectedOrgId=j.id; msg.style.color='green'; msg.textContent='Organization saved! id='+j.id;
    selectedOrg.textContent='Org ID: '+j.id;
  }catch(e){msg.style.color='red';msg.textContent=e.message;}
};

btnSearchOrg.onclick=async()=>{
  const q=searchOrgQ.value.trim(); if(!q)return;
  const r=await fetch(base+'/organizations?q='+encodeURIComponent(q),{headers:{Authorization:'Bearer '+getToken()}});
  const j=await r.json(); const el=searchResults; el.innerHTML='';
  if(!j.ok)return el.textContent=JSON.stringify(j);
  j.organizations.forEach(o=>{
    const div=document.createElement('div');
    div.innerHTML=`<b>${o.name}</b> (${o.location||''}) — id:${o.id} <button data-id="${o.id}">Select</button>`;
    el.appendChild(div);
    div.querySelector('button').onclick=()=>{selectedOrgId=o.id;selectedOrg.textContent='Org ID:'+o.id+' - '+o.name;};
  });
};

btnInvite.onclick=async()=>{
  const name=userName.value.trim(),email=userEmail.value.trim(),department=userDept.value.trim(),role=userRole.value;
  const msg=inviteMsg; if(!selectedOrgId){msg.style.color='red';msg.textContent='Select org first';return;}
  try{
    const r=await fetch(base+'/users/invite',{method:'POST',headers:headers(),body:JSON.stringify({name,email,department,role,org_id:selectedOrgId})});
    const j=await r.json(); if(!r.ok){msg.style.color='red';msg.textContent=JSON.stringify(j);return;}
    msg.style.color='green'; msg.textContent=j.msg||'Invite sent';
  }catch(e){msg.style.color='red';msg.textContent=e.message;}
};

btnSkip.onclick=async()=>{
  const r=await fetch(base+'/auth/me',{headers:{Authorization:'Bearer '+getToken()}});
  if(!r.ok)return window.location='/index.html';
  const j=await r.json(); const u=j.user;
  if(u.role==='organization_admin'&&!u.org_id){alert('Organization admin must create an organization first.');return;}
  window.location='/bookings.html';
};
</script>
</body>
</html>

