<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>EasyQue - Organization setup</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; max-width:1000px; }
    .card { background:#fff;border:1px solid #ddd;padding:18px;border-radius:8px;margin-bottom:20px; }
    label { display:block;margin-top:8px;font-weight:600; }
    input, textarea, select { width:100%; padding:8px; margin-top:6px; box-sizing:border-box; border:1px solid #ccc;border-radius:6px; }
    button { padding:8px 12px;border-radius:6px;border:0;background:#007bff;color:#fff;margin-top:12px; cursor:pointer; }
    .muted { color:#666; font-size:0.9em; }
    #orgMsg, #inviteMsg { margin-top:8px; }
  </style>
</head>
<body>

<!-- Admin fees button (add below your Save Organization button) -->
<div style="margin-top:18px;">
  <button id="btnEditFees" style="background:#1f8bff;color:#fff;padding:8px 12px;border-radius:6px;border:0;cursor:pointer;">Add / Edit Fee structure</button>
  <div id="feesMsg" style="margin-top:8px;color:#666;"></div>
</div>

<!-- Modal (hidden) -->
<div id="feesModal" style="display:none;position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;">
  <div style="background:#fff;padding:18px;border-radius:8px;width:420px;margin:auto">
    <h3>Fee settings</h3>
    <label>Annual fee (INR)</label><input id="fee_annual" type="number" min="0" step="0.01" style="width:100%;padding:8px;margin-top:6px;">
    <label>Monthly platform fee per user (INR)</label><input id="fee_monthly_user" type="number" min="0" step="0.01" style="width:100%;padding:8px;margin-top:6px;">
    <label>Message cost per booking (INR)</label><input id="fee_message_cost" type="number" min="0" step="0.01" style="width:100%;padding:8px;margin-top:6px;">
    <label>Free trial days</label><input id="fee_trial_days" type="number" min="0" step="1" style="width:100%;padding:8px;margin-top:6px;">
    <div style="margin-top:12px;text-align:right;">
      <button id="feesCancel" style="margin-right:8px;">Cancel</button>
      <button id="feesSave" style="background:#0b8b59;color:#fff;padding:6px 10px;border-radius:6px;border:0;">Save</button>
    </div>
  </div>
</div>
<script>
  async function loadFeesToModal() {
    try {
      const r = await fetch('/signup/options'); // earlier route returns fees
      const j = await r.json();
      const fees = j.fees || {};
      document.getElementById('fee_annual').value = fees.annual_fee || '';
      document.getElementById('fee_monthly_user').value = fees.monthly_platform_fee_per_user || '';
      document.getElementById('fee_message_cost').value = fees.message_cost_per_booking || '';
      document.getElementById('fee_trial_days').value = j.free_trial_days || '';
    } catch (e) {
      console.error('load fees error', e);
    }
  }
  document.getElementById('btnEditFees').addEventListener('click', async () => {
    await loadFeesToModal();
    document.getElementById('feesModal').style.display = 'flex';
  });
  document.getElementById('feesCancel').addEventListener('click', () => document.getElementById('feesModal').style.display = 'none');
  document.getElementById('feesSave').addEventListener('click', async () => {
    const payload = {
      key: 'annual_fee', value: Number(document.getElementById('fee_annual').value || 0)
    };
    try {
      // update keys one by one (admin route expects key,value)
      const updates = [
        { key: 'annual_fee', value: Number(document.getElementById('fee_annual').value || 0) },
        { key: 'monthly_platform_fee_per_user', value: Number(document.getElementById('fee_monthly_user').value || 0) },
        { key: 'message_cost_per_booking', value: Number(document.getElementById('fee_message_cost').value || 0) },
        { key: 'free_trial_days', value: Number(document.getElementById('fee_trial_days').value || 7) }
      ];
      for (const u of updates) {
        await fetch('/admin/fees', { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('accessToken') }, body: JSON.stringify({ key: u.key, value: u.value }) });
      }
      document.getElementById('feesMsg').textContent = 'Fees updated';
      document.getElementById('feesModal').style.display = 'none';
    } catch (err) {
      alert('Failed to save fees: ' + err.message);
    }
  });
</script>

  <h1>Organization setup</h1>
  <div class="card">
    <div id="loggedIn" class="muted">Logged in as ...</div>
    <h3>Organization Details</h3>
    <label>Name</label><input id="orgName">
    <label>Location</label><input id="orgLocation">
    <label>Services</label><textarea id="orgServices"></textarea>
    <label>Photo URL (public)</label><input id="orgPhoto" placeholder="https://...">
    <button id="btnSaveOrg">Save Organization</button>
    <div id="orgMsg"></div>
  </div>

  <div class="card">
    <h3>Or — Search existing organization (admin)</h3>
    <label>Search by id or name</label><input id="searchOrgQ"><button id="btnSearchOrg">Search</button>
    <div id="searchResults"></div>
  </div>

  <div class="card">
    <h3>Add Assigned / Receptionist</h3>
    <div class="muted">Selected organization: <span id="selectedOrg">None</span></div>
    <label>Role</label>
    <select id="userRole"><option value="assigned">Assigned user</option><option value="receptionist">Receptionist</option></select>
    <label>Name</label><input id="userName">
    <label>Email</label><input id="userEmail">
    <label>Department</label><input id="userDept">
    <button id="btnInvite">Send Invite</button>
    <div id="inviteMsg"></div>
  </div>

  <div style="margin-top:10px">
    <button id="btnSkip">Skip and Continue to Bookings</button>
  </div>

<script>
const base=window.location.origin;
let me=null,selectedOrgId=null;

function getToken(){return localStorage.getItem('accessToken')||'';}
function headers(){return {'Content-Type':'application/json','Authorization':'Bearer '+getToken()};}

async function whoami(){
  const t=getToken(); if(!t) return window.location='/index.html';
  try{
    const r=await fetch(base+'/auth/me',{headers:{Authorization:'Bearer '+t}});
    if(!r.ok) return window.location='/index.html';
    const j=await r.json(); if(!j.ok) return window.location='/index.html';
    me=j.user; document.getElementById('loggedIn').innerText=`Logged in as ${me.name} (${me.role})`;
    if(me.org_id){selectedOrgId=me.org_id;document.getElementById('selectedOrg').innerText='Org ID: '+me.org_id;}
  }catch(e){window.location='/index.html';}
}
whoami();

document.getElementById('btnSaveOrg').onclick=async()=>{
  const name=orgName.value.trim(),location=orgLocation.value.trim(),services=orgServices.value.trim(),photo=orgPhoto.value.trim();
  const msg=orgMsg; msg.textContent='Saving...';
  try{
    const r=await fetch(base+'/organizations',{method:'POST',headers:headers(),body:JSON.stringify({name,location,services,photo})});
    const j=await r.json(); if(!r.ok){msg.style.color='red';msg.textContent=JSON.stringify(j);return;}
    selectedOrgId=j.id; msg.style.color='green'; msg.textContent='Organization saved! id='+j.id;
    selectedOrg.textContent='Org ID: '+j.id;
  }catch(e){msg.style.color='red';msg.textContent=e.message;}
};

btnSearchOrg.onclick=async()=>{
  const q=searchOrgQ.value.trim(); if(!q)return;
  const r=await fetch(base+'/organizations?q='+encodeURIComponent(q),{headers:{Authorization:'Bearer '+getToken()}});
  const j=await r.json(); const el=searchResults; el.innerHTML='';
  if(!j.ok)return el.textContent=JSON.stringify(j);
  j.organizations.forEach(o=>{
    const div=document.createElement('div');
    div.innerHTML=`<b>${o.name}</b> (${o.location||''}) — id:${o.id} <button data-id="${o.id}">Select</button>`;
    el.appendChild(div);
    div.querySelector('button').onclick=()=>{selectedOrgId=o.id;selectedOrg.textContent='Org ID:'+o.id+' - '+o.name;};
  });
};

btnInvite.onclick=async()=>{
  const name=userName.value.trim(),email=userEmail.value.trim(),department=userDept.value.trim(),role=userRole.value;
  const msg=inviteMsg; if(!selectedOrgId){msg.style.color='red';msg.textContent='Select org first';return;}
  try{
    const r=await fetch(base+'/users/invite',{method:'POST',headers:headers(),body:JSON.stringify({name,email,department,role,org_id:selectedOrgId})});
    const j=await r.json(); if(!r.ok){msg.style.color='red';msg.textContent=JSON.stringify(j);return;}
    msg.style.color='green'; msg.textContent=j.msg||'Invite sent';
  }catch(e){msg.style.color='red';msg.textContent=e.message;}
};

btnSkip.onclick=async()=>{
  const r=await fetch(base+'/auth/me',{headers:{Authorization:'Bearer '+getToken()}});
  if(!r.ok)return window.location='/index.html';
  const j=await r.json(); const u=j.user;
  if(u.role==='organization_admin'&&!u.org_id){alert('Organization admin must create an organization first.');return;}
  window.location='/bookings.html';
};
</script>
</body>
</html>
