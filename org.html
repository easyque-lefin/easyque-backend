<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Org / Fees — EasyQue</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f7f9fb;padding:20px}
    .card{max-width:920px;margin:20px auto;padding:22px;background:#fff;border-radius:8px;border:1px solid #eee}
    h1{margin:0 0 12px}
    label{display:block;font-weight:700;margin-top:12px}
    input,select{width:100%;padding:10px;margin-top:6px;border-radius:6px;border:1px solid #ddd}
    button{background:#0b74de;color:#fff;border:0;padding:10px 14px;border-radius:6px;margin-top:10px;cursor:pointer}
    .fees{white-space:pre-wrap;font-family:monospace;padding:12px;border-radius:6px;border:1px dashed #eee;background:#fafafa}
    .muted{color:#666;margin-top:8px}
    .inline{display:inline-block}
  </style>
</head>
<body>
  <div class="card">
    <h1>Fee settings</h1>
    <div id="feeList" class="fees">Loading fee settings...</div>

    <div style="display:flex;gap:8px;margin-top:12px">
      <input id="feeKey" placeholder="fee key (e.g. monthly_platform_fee_per_user)">
      <input id="feeVal" placeholder="value (number or text)">
      <button id="btnSave">Save</button>
    </div>

    <div class="muted" style="margin-top:10px">To edit fees programmatically you can also use PUT /admin/fees (requires admin auth).</div>

    <hr style="margin:18px 0">

    <h2>View charges (sample)</h2>
    <div class="muted">Pick a mode and sample inputs to preview the initial amount that will be charged.</div>

    <label>Mode</label>
    <select id="mode">
      <option value="semi">Semi-Automatic (use your phone)</option>
      <option value="full">Full-Automatic (we send messages)</option>
    </select>

    <div style="display:flex;gap:12px">
      <div style="flex:1">
        <label>Users (org)</label>
        <input id="users" type="number" value="10">
      </div>
      <div style="width:300px">
        <label>Bookings/day (full mode only)</label>
        <input id="bookingsDay" type="number" value="500">
      </div>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:14px">
      <div>
        <button id="btnCalc">Calculate charge</button>
        <div id="calcMsg" class="muted">Press calculate to fetch server-side estimate.</div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:700">Estimated initial amount:</div>
        <div style="font-size:20px;margin-top:6px" id="calcResult">—</div>
      </div>
    </div>
  </div>

<script>
(async function(){
  function token() { return localStorage.getItem('accessToken') || null; }
  async function fetchJSON(url, opts) {
    opts = opts || {}; opts.headers = opts.headers || {};
    const t = token();
    if (t) opts.headers['Authorization'] = 'Bearer ' + t;
    const r = await fetch(url, opts);
    const txt = await r.text().catch(()=>null);
    const ct = r.headers.get('content-type') || '';
    if (!r.ok) { const err = new Error('HTTP ' + r.status + ': ' + (txt || r.statusText)); err.body = txt; throw err; }
    if (ct.indexOf('application/json') !== -1) return JSON.parse(txt);
    return txt;
  }

  const feeList = document.getElementById('feeList');
  const feeKey = document.getElementById('feeKey');
  const feeVal = document.getElementById('feeVal');
  const btnSave = document.getElementById('btnSave');
  const btnCalc = document.getElementById('btnCalc');
  const calcResult = document.getElementById('calcResult');
  const calcMsg = document.getElementById('calcMsg');

  async function loadFees() {
    feeList.textContent = 'Loading fee settings...';
    try {
      const j = await fetchJSON('/admin/fees');
      if (j && j.ok && j.fees) {
        renderFees(j.fees);
        return;
      }
      // fallback: payments/calc to read feeSettings snapshot
      const calc = await fetchJSON('/payments/calc?messaging_mode=semi&expected_users=0&expected_bookings_per_day=0');
      if (calc && calc.feeSettings) {
        renderFees(calc.feeSettings);
        return;
      }
      feeList.textContent = 'No fee settings available';
    } catch (e) {
      feeList.textContent = 'Error loading fees: ' + (e && e.message || e);
      console.error('loadFees', e);
    }
  }

  function renderFees(map) {
    if (!map || Object.keys(map).length === 0) { feeList.textContent = 'No fee settings'; return; }
    // map may have values that are objects (if older code returned rows). Normalize:
    const out = [];
    for (const k of Object.keys(map)) {
      let v = map[k];
      if (typeof v === 'object' && v !== null) {
        if ('value_decimal' in v) v = v.value_decimal;
        else if ('value' in v) v = v.value;
        else v = JSON.stringify(v);
      }
      out.push(`${k} = ${v}`);
    }
    feeList.textContent = out.join('\n');
  }

  btnSave.addEventListener('click', async () => {
    const k = (feeKey.value||'').trim();
    const v = (feeVal.value||'').trim();
    if (!k) return alert('Enter fee key');
    if (v === '') return alert('Enter value');
    try {
      const j = await fetchJSON('/admin/fees', { method: 'PUT', body: JSON.stringify({ key:k, value:v }), headers: { 'Content-Type': 'application/json' } });
      if (j && j.ok) {
        alert('Saved');
        feeKey.value = ''; feeVal.value = '';
        await loadFees();
      } else {
        alert('Save failed: ' + JSON.stringify(j));
      }
    } catch (e) {
      alert('Save failed: ' + (e && e.message || e));
    }
  });

  btnCalc.addEventListener('click', async () => {
    const mode = document.getElementById('mode').value;
    const users = Number(document.getElementById('users').value || 0);
    const bookings = Number(document.getElementById('bookingsDay').value || 0);
    calcResult.textContent = '...';
    calcMsg.textContent = 'Fetching server-side calculation...';
    try {
      const url = `/payments/calc?messaging_mode=${encodeURIComponent(mode)}&expected_users=${encodeURIComponent(users)}&expected_bookings_per_day=${encodeURIComponent(bookings)}`;
      const j = await fetchJSON(url);
      if (!j || !j.ok) { calcResult.textContent = 'error'; calcMsg.textContent = 'Server returned invalid response'; return; }
      calcResult.textContent = '₹' + (j.amount_rupees || 0);
      calcMsg.textContent = 'Calculation from server (uses current fee_settings)';
    } catch (e) {
      calcResult.textContent = '—';
      calcMsg.textContent = 'Calculation failed: ' + (e && e.message || e);
    }
  });

  await loadFees();
})();
</script>
</body>
</html>

