<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>EasyQue — Bookings</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f4f7fb;padding:20px}
    .container{max-width:1100px;margin:0 auto;display:flex;gap:20px}
    .left,.right{background:#fff;padding:18px;border-radius:8px;border:1px solid #eee}
    .left{width:360px}
    .right{flex:1}
    label{display:block;font-weight:700;margin-top:10px}
    input,select{width:100%;padding:10px;border-radius:6px;border:1px solid #e5e9f2;margin-top:6px}
    button{background:#1b6eff;color:#fff;padding:8px 12px;border:0;border-radius:6px;margin-top:12px;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border-bottom:1px solid #f0f2f8;text-align:left}
    .muted{color:#6b7280;font-size:13px}
    .error{color:#b00020;margin-top:8px}
  </style>
</head>
<body>
  <h1>EasyQue — Bookings</h1>
  <div class="container">
    <div class="left">
      <h3>Create booking</h3>
      <label>Organization</label>
      <select id="orgSelect"><option>Loading organizations...</option></select>

      <label>Department</label>
      <select id="deptSelect"><option>-- choose dept --</option></select>

      <label>Assigned user</label>
      <select id="userSelect"><option>-- choose assigned user --</option></select>

      <label>Customer name</label>
      <input id="custName">

      <label>Customer phone</label>
      <input id="custPhone">

      <button id="btnCreate">Create booking (demo)</button>
      <div id="leftMsg" class="muted">Use this form to create a booking for the selected org.</div>
      <div id="leftError" class="error" style="display:none"></div>
    </div>

    <div class="right">
      <h3>Bookings</h3>
      <div style="display:flex;gap:12px;align-items:center">
        <input id="filterDate" type="date" style="max-width:200px">
        <button id="btnReload">Reload</button>
        <div style="margin-left:auto" class="muted">Select organization to show bookings</div>
      </div>

      <div id="bookingsMsg" class="muted" style="margin-top:12px">No organization selected.</div>

      <table id="bookingsTable" style="display:none">
        <thead><tr><th>ID</th><th>Token</th><th>Name</th><th>Phone</th><th>Assigned</th><th>Date</th><th>Status</th></tr></thead>
        <tbody id="bookingsBody"></tbody>
      </table>

      <div id="rightError" class="error" style="display:none"></div>
    </div>
  </div>

<script>
(async function(){
  function token(){ return localStorage.getItem('accessToken') || null; }
  async function fetchJSON(url, opts) {
    opts = opts || {}; opts.headers = opts.headers || {};
    const t = token(); if (t) opts.headers['Authorization'] = 'Bearer ' + t;
    const r = await fetch(url, opts);
    const txt = await r.text().catch(()=>null);
    const ct = r.headers.get('content-type') || '';
    if (!r.ok) {
      const e = new Error('HTTP ' + r.status + ': ' + (txt || r.statusText));
      e.body = txt; throw e;
    }
    if (ct.indexOf('application/json') !== -1) return JSON.parse(txt);
    return txt;
  }

  const orgSelect = document.getElementById('orgSelect');
  const deptSelect = document.getElementById('deptSelect');
  const userSelect = document.getElementById('userSelect');
  const btnCreate = document.getElementById('btnCreate');
  const btnReload = document.getElementById('btnReload');
  const bookingsMsg = document.getElementById('bookingsMsg');
  const bookingsTable = document.getElementById('bookingsTable');
  const bookingsBody = document.getElementById('bookingsBody');
  const leftError = document.getElementById('leftError');
  const rightError = document.getElementById('rightError');

  async function loadOrgs() {
    orgSelect.innerHTML = '<option>Loading organizations...</option>';
    try {
      const j = await fetchJSON('/organizations');
      if (!j || !j.ok) throw new Error('Invalid organizations response');
      const arr = j.organizations || [];
      orgSelect.innerHTML = '<option value="">-- choose org --</option>';
      arr.forEach(o => {
        const opt = document.createElement('option');
        opt.value = o.id;
        opt.textContent = `${o.name} (${o.id})`;
        orgSelect.appendChild(opt);
      });
    } catch (e) {
      orgSelect.innerHTML = '<option>-- unable to load orgs --</option>';
      bookingsMsg.textContent = 'Error loading organizations: ' + (e && e.message || e);
      console.error('loadOrgs error', e);
    }
  }

  async function loadOrgDetails(id) {
    if (!id) return;
    deptSelect.innerHTML = '<option>Loading...</option>';
    userSelect.innerHTML = '<option>Loading...</option>';
    bookingsMsg.textContent = 'Loading organization details...';
    try {
      const j = await fetchJSON('/organizations/' + encodeURIComponent(id));
      if (!j || !j.ok) throw new Error('Invalid org response');
      const deps = j.departments || [];
      const users = j.users || [];
      deptSelect.innerHTML = '<option value="">-- choose dept --</option>';
      deps.forEach(d => { const opt = document.createElement('option'); opt.value=d.id; opt.textContent=d.name; deptSelect.appendChild(opt); });
      userSelect.innerHTML = '<option value="">-- choose assigned user --</option>';
      users.forEach(u => { const opt = document.createElement('option'); opt.value=u.id; opt.textContent = u.name || u.email; userSelect.appendChild(opt); });

      await loadBookingsForOrg(id);
    } catch (e) {
      deptSelect.innerHTML = '<option>-- error --</option>';
      userSelect.innerHTML = '<option>-- error --</option>';
      bookingsMsg.textContent = 'Error loading organization: ' + (e && e.message || e);
      console.error('loadOrgDetails', e);
    }
  }

  async function loadBookingsForOrg(orgId) {
    bookingsMsg.textContent = 'Loading bookings...';
    bookingsTable.style.display = 'none';
    rightError.style.display = 'none';
    try {
      // try common endpoint shapes
      let r = await fetch(`/bookings?org_id=${encodeURIComponent(orgId)}`);
      if (r.status === 404) r = await fetch(`/bookings?org=${encodeURIComponent(orgId)}`);
      if (!r.ok) {
        const txt = await r.text().catch(()=>null);
        throw new Error('Failed to fetch bookings: ' + (txt || r.statusText));
      }
      const ct = r.headers.get('content-type') || '';
      const txt = await r.text();
      if (ct.indexOf('application/json') === -1) {
        bookingsMsg.textContent = 'Bookings endpoint returned non-JSON (check server).';
        console.warn('bookings returned non-json', txt);
        return;
      }
      const j = JSON.parse(txt);
      let arr = [];
      if (Array.isArray(j)) arr = j;
      else if (j.ok && Array.isArray(j.bookings)) arr = j.bookings;
      else if (Array.isArray(j.bookings)) arr = j.bookings;
      else if (Array.isArray(j.data)) arr = j.data;
      else {
        bookingsMsg.textContent = 'No bookings returned by server';
        return;
      }
      populateBookings(arr);
    } catch (e) {
      bookingsMsg.textContent = 'Unable to load bookings: ' + (e && e.message || e);
      console.error('loadBookingsForOrg', e);
    }
  }

  function populateBookings(arr) {
    bookingsBody.innerHTML = '';
    if (!arr || arr.length === 0) {
      bookingsMsg.textContent = 'No bookings found';
      bookingsTable.style.display = 'none';
      return;
    }
    bookingsTable.style.display = '';
    bookingsMsg.textContent = '';
    arr.forEach(b => {
      const tr = document.createElement('tr');
      const id = b.id || b.booking_id || '';
      const token = b.token || '';
      const name = b.name || b.customer_name || '';
      const phone = b.phone || b.customer_phone || '';
      const assigned = b.assigned_name || b.assigned_user || '';
      const date = b.date || b.booking_date || '';
      const status = b.status || b.state || '';
      tr.innerHTML = `<td>${id}</td><td>${token}</td><td>${escapeHtml(name)}</td><td>${escapeHtml(phone)}</td><td>${escapeHtml(assigned)}</td><td>${escapeHtml(date)}</td><td>${escapeHtml(status)}</td>`;
      bookingsBody.appendChild(tr);
    });
  }

  function escapeHtml(s) {
    if (!s && s !== 0) return '';
    return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
  }

  btnCreate.addEventListener('click', async () => {
    leftError.style.display = 'none';
    const orgId = orgSelect.value;
    const deptId = deptSelect.value || null;
    const userId = userSelect.value || null;
    const name = (document.getElementById('custName').value || '').trim();
    const phone = (document.getElementById('custPhone').value || '').trim();
    if (!orgId) { leftError.style.display='block'; leftError.textContent='Please select org'; return; }
    if (!name || !phone) { leftError.style.display='block'; leftError.textContent='Name & phone required'; return; }
    try {
      const body = { org_id: orgId, department_id: deptId, assigned_user_id: userId, name, phone, booking_date: new Date().toISOString().slice(0,10) };
      const resp = await fetch('/bookings', { method: 'POST', headers: { 'Content-Type':'application/json', ...(token()? { 'Authorization':'Bearer '+token() } : {}) }, body: JSON.stringify(body) });
      if (!resp.ok) {
        const t = await resp.text().catch(()=>null);
        throw new Error('Server error: ' + (t || resp.statusText));
      }
      leftMsg.textContent = 'Booking created. Reloading...';
      await loadBookingsForOrg(orgId);
    } catch (e) {
      leftError.style.display='block'; leftError.textContent = 'Create booking failed: ' + (e && e.message || e);
    }
  });

  orgSelect.addEventListener('change', async () => { const id = orgSelect.value; if (!id) { bookingsMsg.textContent='No organization selected'; bookingsTable.style.display='none'; return; } await loadOrgDetails(id); });
  btnReload.addEventListener('click', async () => { const id = orgSelect.value; if (!id) { bookingsMsg.textContent='Select organization first'; return; } await loadBookingsForOrg(id); });

  await loadOrgs();
})();
</script>
</body>
</html>
